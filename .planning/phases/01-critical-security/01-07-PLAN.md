---
phase: 01-critical-security
plan: 07
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: true
gap_closure: true
must_haves:
  truths:
    - "audit_logs INSERT policy enforces role validation, email verification, REVERT_ACTION restriction, and timestamp validation"
  artifacts:
    - path: "supabase/migrations/20250122085026_audit_logs_rls.sql"
      provides: "Secure RLS policy for audit_logs INSERT operations"
      contains: "CREATE POLICY audit_logs_insert_officer_plus"
  key_links:
    - from: "Supabase database"
      to: "supabase/migrations/20250122085026_audit_logs_rls.sql"
      via: "Migration application via Supabase migrations system"
      pattern: "Migration must be applied to synchronize database state"
---

<objective>
Apply the audit_logs RLS migration to the Supabase database to close the security gap.

Purpose: Migration 20250122085026_audit_logs_rls.sql exists and is correct, but was never applied to the actual Supabase database. The database currently has a permissive policy (with_check=true) while the migration defines a secure policy with role validation, email verification, REVERT_ACTION restriction, and timestamp validation.

Output: Database state synchronized with migration - audit_logs INSERT policy enforces all documented security controls.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/01-critical-security/01-UAT.md
@.planning/debug/audit_logs_rls_gap.md
@.planning/phases/01-critical-security/01-03-SUMMARY.md
@supabase/migrations/20250122085026_audit_logs_rls.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Drop existing permissive audit_logs INSERT policy</name>
  <files>supabase/migrations/20250122085026_audit_logs_rls.sql</files>
  <action>
    The UAT test found policy "audit_logs_insert" with with_check=true in the database. This permissive policy must be dropped before the secure policy from migration 20250122085026_audit_logs_rls.sql can be applied.

    First, verify current policy state in the database by querying pg_policies:
    ```sql
    SELECT policyname, permissive, roles, cmd, qual, with_check
    FROM pg_policies
    WHERE schemaname = 'public' AND tablename = 'audit_logs';
    ```

    Then drop the existing permissive policy:
    ```sql
    DROP POLICY IF EXISTS audit_logs_insert ON public.audit_logs;
    ```

    IMPORTANT: This uses the Supabase MCP to execute SQL directly against the database. Do NOT create a new migration file - this is a remediation action to fix the out-of-sync database state.
  </action>
  <verify>
    Query pg_policies to confirm audit_logs has no INSERT policy after DROP:
    ```sql
    SELECT policyname FROM pg_policies
    WHERE schemaname = 'public' AND tablename = 'audit_logs' AND cmd = 'INSERT';
    ```
    Expected: 0 rows (no INSERT policy exists)
  </verify>
  <done>Existing permissive audit_logs_insert policy is dropped from database</done>
</task>

<task type="auto">
  <name>Task 2: Apply audit_logs RLS migration to Supabase database</name>
  <files>supabase/migrations/20250122085026_audit_logs_rls.sql</files>
  <action>
    Apply the migration 20250122085026_audit_logs_rls.sql to the Supabase database. The migration file contains:
    1. ALTER TABLE to ENABLE ROW LEVEL SECURITY
    2. REVOKE INSERT from anon
    3. CREATE POLICY audit_logs_insert_officer_plus with security controls

    Use the Supabase migrations system to apply this migration. This can be done via:
    - Supabase CLI: `supabase db push` (if connected to remote project)
    - Or direct SQL execution via Supabase MCP

    Execute the full content of 20250122085026_audit_logs_rls.sql against the database.
  </action>
  <verify>
    Query pg_policies to confirm the secure policy exists:
    ```sql
    SELECT policyname, permissive, roles, cmd, qual, with_check
    FROM pg_policies
    WHERE schemaname = 'public' AND tablename = 'audit_logs' AND cmd = 'INSERT';
    ```
    Expected: 1 row with policyname='audit_logs_insert_officer_plus' and complex with_check expression containing role validation, email verification, and REVERT_ACTION restriction.
  </verify>
  <done>Migration 20250122085026_audit_logs_rls.sql is applied to Supabase database</done>
</task>

</tasks>

<verification>
1. Verify policy name changed from "audit_logs_insert" to "audit_logs_insert_officer_plus"
2. Verify with_check expression is complex (not just "true")
3. Verify RLS is enabled on audit_logs table
4. Re-run UAT Test 3 to confirm gap is closed
</verification>

<success_criteria>
- Database audit_logs INSERT policy is "audit_logs_insert_officer_plus"
- Policy enforces: role validation via EXISTS subquery on user_roles
- Policy enforces: email verification via auth.jwt() ->> 'email' comparison
- Policy enforces: REVERT_ACTION restriction to admin role
- Policy enforces: timestamp validation (within 5 minutes past, 1 minute future)
- UAT Test 3 passes after remediation
</success_criteria>

<output>
After completion, create `.planning/phases/01-critical-security/01-07-SUMMARY.md`
</output>
