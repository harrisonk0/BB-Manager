---
phase: 01-critical-security
plan: 04
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Service role key is not present in client-side code"
    - "No VITE_* prefixed variables contain service_role"
    - "Service role key only referenced in services/backend code"
    - "No base64-encoded strings matching service role pattern"
  artifacts:
    - path: "services/supabaseClient.ts"
      provides: "Verified anon-key-only client"
      contains: "VITE_SUPABASE_ANON_KEY"
  key_links:
    - from: "Client code (components, hooks)"
      to: "services/supabaseClient.ts"
      via: "import"
      pattern: "supabase"
---

<objective>
Verify service_role key isolation from client-side code

Purpose: Service role key bypasses all RLS policies and must never be exposed in client-side bundles. This plan scans the codebase for common service role patterns, verifies only anon key is used client-side, and confirms no VITE_-prefixed environment variables contain service role secrets.

Output: Verification report confirming service role key isolation
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/01-critical-security/01-RESEARCH.md
@services/supabaseClient.ts
</context>

<tasks>

<task type="auto">
  <name>Scan for service_role patterns in codebase</name>
  <files>.</files>
  <action>
    Run comprehensive grep scans for service role key patterns:

    1. grep -ri "service_role\|SERVICE_ROLE\|serviceRole" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" .
    2. grep -ri "eyJ.*c2VydmljZV9yb2xl" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" . (base64 pattern containing "service_role")
    3. grep -r "VITE_.*KEY\|VITE_.*SECRET\|VITE_.*ROLE" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" .

    Document any findings. Expected result: zero matches for service_role patterns in client code.

    Why: Service role key exposure is a critical security vulnerability. The service role key bypasses RLS entirely - if exposed in client code, any user could perform any database operation. These scans check for common leakage patterns.

    If any service role references are found in client code (components/, hooks/, or files importing from services/supabaseClient.ts), this is a BLOCKER that must be fixed before phase completion.
  </action>
  <verify>echo "Scan completed - check results above"</verify>
  <done>All grep scans return zero matches for service_role patterns in client code</done>
</task>

<task type="auto">
  <name>Verify supabaseClient.ts uses anon key only</name>
  <files>services/supabaseClient.ts</files>
  <action>
    1. Read services/supabaseClient.ts
    2. Verify it imports and uses only VITE_SUPABASE_ANON_KEY
    3. Confirm no references to service_role, SERVICE_ROLE_KEY, or similar
    4. Verify the error message mentions only VITE_SUPABASE_URL and VITE_SUPABASE_ANON_KEY

    Expected state: File creates Supabase client using anon key only, with clear error message if environment variables are missing.

    Why: The supabaseClient.ts is the single source of Supabase client initialization for client code. If this file correctly uses anon key only, all client-side database operations will respect RLS policies.
  </action>
  <verify>grep -q "VITE_SUPABASE_ANON_KEY" /Users/harrisonk/dev/BB-Manager/services/supabaseClient.ts && ! grep -q "service_role\|SERVICE_ROLE" /Users/harrisonk/dev/BB-Manager/services/supabaseClient.ts</verify>
  <done>supabaseClient.ts uses VITE_SUPABASE_ANON_KEY only, no service role references</done>
</task>

<task type="auto">
  <name>Scan .env and .env.example for service role patterns</name>
  <files>.env.example</files>
  <action>
    1. Check if .env.example exists
    2. grep -i "service_role\|SERVICE_ROLE" .env.example (if exists)
    3. Verify any Supabase key variables are clearly marked as ANON_KEY only

    Expected state: .env.example documents VITE_SUPABASE_ANON_KEY (safe for client) and possibly SUPABASE_SERVICE_ROLE_KEY (server-side only, never prefixed with VITE_).

    Why: .env.example documents expected environment variables. If it shows VITE_SERVICE_ROLE_KEY as an example, developers might copy that pattern and expose service role keys in production.
  </action>
  <verify>grep -i "VITE.*SERVICE" .env.example 2>/dev/null || echo "No VITE-prefixed service role variables found"</verify>
  <done>No VITE_-prefixed service role variables in .env.example</done>
</task>

<task type="auto">
  <name>Document service role key isolation verification</name>
  <files>.planning/phases/01-critical-security/01-04-SUMMARY.md</files>
  <action>
    Create a summary document containing:
    1. Scan results for all grep patterns (showing zero matches)
    2. Confirmation that services/supabaseClient.ts uses anon key only
    3. Confirmation that no VITE_* variables contain service_role
    4. Statement: "Service role key is verified isolated from client-side code"

    This document serves as evidence that the security requirement SEC-04 is satisfied.

    Why: Documentation of the verification provides an audit trail and allows re-verification if code changes occur. The summary will be referenced during phase completion verification.
  </action>
  <verify>ls -la /Users/harrisonk/dev/BB-Manager/.planning/phases/01-critical-security/01-04-SUMMARY.md</verify>
  <done>Summary document exists with verification results</done>
</task>

</tasks>

<verification>
1. grep -ri "service_role" --include="*.ts" --include="*.tsx" . returns zero matches in client code
2. grep -r "VITE_.*SERVICE" --include="*.ts" --include="*.tsx" . returns zero matches
3. services/supabaseClient.ts contains VITE_SUPABASE_ANON_KEY but no service_role references
4. Summary document exists with verification results
</verification>

<success_criteria>
1. Zero service_role references in client-side code (components/, hooks/)
2. supabaseClient.ts uses anon key only
3. No VITE_-prefixed service role variables
4. Verification summary documented
</success_criteria>

<output>
After completion, create `.planning/phases/01-critical-security/01-04-SUMMARY.md`
</output>
