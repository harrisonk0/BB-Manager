---
phase: 01-critical-security
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20251214144110_remote_schema.sql
autonomous: true
user_setup: []

must_haves:
  truths:
    - "RLS policy exists for audit_logs INSERT operations"
    - "Policy prevents impersonation (user_id must match auth.uid())"
    - "Policy validates timestamp is within reasonable range"
    - "REVERT_ACTION is restricted to admin role only"
  artifacts:
    - path: "supabase/migrations/20251214144110_remote_schema.sql"
      provides: "audit_logs_insert RLS policy"
      contains: "CREATE POLICY audit_logs_insert"
  key_links:
    - from: "audit_logs_insert_authenticated"
      to: "public.audit_logs"
      via: "RLS policy WITH CHECK"
      pattern: "auth.uid()"
---

<objective>
Fix audit_logs_insert RLS policy to prevent unauthorized INSERT operations

Purpose: The current implementation has no RLS policies on audit_logs. This plan creates a secure INSERT policy that: (1) allows all authenticated users to write audit logs, (2) prevents user_id spoofing by enforcing user_id = auth.uid(), (3) validates timestamps are reasonable, and (4) restricts REVERT_ACTION to admin role only.

Output: Secure RLS policy for audit_logs INSERT operations
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/01-critical-security/01-RESEARCH.md
@.planning/phases/01-critical-security/01-CONTEXT.md
@docs/10-database-security-model.md
@supabase/migrations/20251214144110_remote_schema.sql
</context>

<tasks>

<task type="auto">
  <name>Enable RLS on audit_logs table</name>
  <files>supabase/migrations/20251214144110_remote_schema.sql</files>
  <action>
    Append to the baseline migration file:

    ```sql
    -- Enable Row Level Security on audit_logs table
    ALTER TABLE public.audit_logs ENABLE ROW LEVEL SECURITY;
    ```

    Why: RLS must be enabled before any RLS policies can take effect. This is a prerequisite for the INSERT policy.

    Note: Append to baseline migration, not modify existing content (baseline is immutable).
  </action>
  <verify>grep -q "ENABLE ROW LEVEL SECURITY" /Users/harrisonk/dev/BB-Manager/supabase/migrations/20251214144110_remote_schema.sql</verify>
  <done>RLS is enabled on audit_logs table</done>
</task>

<task type="auto">
  <name>Create audit_logs INSERT policy with role-based validation</name>
  <files>supabase/migrations/20251214144110_remote_schema.sql</files>
  <action>
    Append to the baseline migration file:

    ```sql
    -- audit_logs_insert_officer_plus
    -- All authenticated users with a role can INSERT audit logs
    -- REVERT_ACTION is restricted to admin role only
    -- user_id must match auth.uid() to prevent impersonation
    -- Timestamp must be within reasonable range
    CREATE POLICY audit_logs_insert_officer_plus
    ON public.audit_logs
    FOR INSERT
    TO authenticated
    WITH CHECK (
      -- User must have an assigned role (officer, captain, or admin)
      EXISTS (
        SELECT 1 FROM public.user_roles
        WHERE uid = auth.uid()::text
      )
      -- user_id must match authenticated user (prevents spoofing)
      AND user_id = auth.uid()::text
      -- Timestamp must be within reasonable range (prevent backdated/future logs)
      AND created_at > NOW() - INTERVAL '5 minutes'
      AND created_at <= NOW() + INTERVAL '1 minute'
      -- REVERT_ACTION restricted to admin only
      AND (
        action_type <> 'REVERT_ACTION'
        OR EXISTS (
          SELECT 1 FROM public.user_roles
          WHERE uid = auth.uid()::text
          AND role = 'admin'
        )
      )
    );
    ```

    Why: Per docs/10-database-security-model.md, all application roles can write audit logs, but REVERT_ACTION is admin-only. The user_id check prevents impersonation attacks where a malicious user tries to create audit logs claiming to be someone else. Timestamp validation prevents backdated or future-dated logs.

    Note: This policy uses EXISTS subquery to check for role membership, which will be replaced with current_app_role() once RLS is fully implemented.
  </action>
  <verify>grep -q "CREATE POLICY audit_logs_insert" /Users/harrisonk/dev/BB-Manager/supabase/migrations/20251214144110_remote_schema.sql</verify>
  <done>RLS policy exists for audit_logs INSERT with proper validation</done>
</task>

<task type="auto">
  <name>Revoke anon INSERT privileges on audit_logs</name>
  <files>supabase/migrations/20251214144110_remote_schema.sql</files>
  <action>
    Append to the baseline migration file:

    ```sql
    -- Revoke INSERT privileges from anon (unauthenticated users)
    -- Unauthenticated users cannot write audit logs
    REVOKE INSERT ON TABLE public.audit_logs FROM anon;
    ```

    Why: The baseline migration grants INSERT on audit_logs to anon. Per the security model, only authenticated users with assigned roles should write audit logs. This revokes that privilege to prevent anonymous audit log creation.

    Note: The RLS policy above only applies to the 'authenticated' role, so we must explicitly revoke from 'anon'.
  </action>
  <verify>grep -q "REVOKE INSERT ON TABLE public.audit_logs FROM anon" /Users/harrisonk/dev/BB-Manager/supabase/migrations/20251214144110_remote_schema.sql</verify>
  <done>Anon users cannot INSERT audit logs</done>
</task>

</tasks>

<verification>
1. grep -q "ENABLE ROW LEVEL SECURITY" supabase/migrations/20251214144110_remote_schema.sql
2. grep -q "CREATE POLICY audit_logs_insert" supabase/migrations/20251214144110_remote_schema.sql
3. grep -q "user_id = auth.uid()" supabase/migrations/20251214144110_remote_schema.sql
4. grep -q "action_type <> 'REVERT_ACTION'" supabase/migrations/20251214144110_remote_schema.sql
5. grep -q "REVOKE INSERT ON TABLE public.audit_logs FROM anon" supabase/migrations/20251214144110_remote_schema.sql
</verification>

<success_criteria>
1. RLS enabled on audit_logs table
2. INSERT policy exists for authenticated users
3. Policy enforces user_id = auth.uid() (no impersonation)
4. Policy restricts REVERT_ACTION to admin role
5. Anon INSERT privileges revoked
6. Timestamp validation in place
</success_criteria>

<output>
After completion, create `.planning/phases/01-critical-security/01-03-SUMMARY.md`
</output>
