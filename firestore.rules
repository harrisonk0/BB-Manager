rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Function to get the role of a specific user from the user_roles collection.
    // Returns null if no user is authenticated or if the user_roles document doesn't exist.
    function getRole(uid) {
      return get(/databases/$(database)/documents/user_roles/$(uid)).data.role;
    }

    // Helper function to check if the user is authenticated.
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if the authenticated user has a specific role.
    function hasRole(role) {
      return isAuthenticated() && getRole(request.auth.uid) == role;
    }

    // Helper function to check if the authenticated user has one of the specified roles.
    function hasAnyRole(roles) {
      return isAuthenticated() && roles.hasAny(getRole(request.auth.uid));
    }

    // --- Global Collections ---

    // User Roles Collection: Stores the assigned role for each user.
    match /user_roles/{userId} {
      allow read: if isAuthenticated(); // All authenticated users can read roles (e.g., for UI display)

      // A new user can create their own role document, but only for 'officer' or 'captain' roles.
      // This prevents self-promotion to admin during signup.
      allow create: if isAuthenticated() &&
        request.auth.uid == userId &&
        request.resource.data.email == request.auth.token.email &&
        request.resource.data.role in ['officer', 'captain'];

      // Update rules for user roles:
      allow update: if isAuthenticated() && (
        // Admin can update any role, with self-demotion protection
        (hasRole('admin') && (
          // Admin cannot demote themselves
          (request.auth.uid == userId && request.resource.data.role == 'admin') ||
          // Admin can demote others, but not another admin to a non-admin role
          (request.auth.uid != userId && (resource.data.role == 'admin' || request.resource.data.role != 'admin'))
        )) ||
        // Captain can update Officer roles, with self-promotion/demotion protection
        (hasRole('captain') && (
          // Captain cannot change an Admin's role
          resource.data.role != 'admin' &&
          // Captain cannot promote themselves to Admin
          !(request.auth.uid == userId && request.resource.data.role == 'admin') &&
          // Captain cannot demote themselves to Officer
          !(request.auth.uid == userId && request.resource.data.role == 'officer') &&
          // Captain can update Officer roles
          request.resource.data.role == 'officer' &&
          request.resource.data.role == 'officer' // Ensure new role is officer
        ))
      );

      // Only Admins can delete user role documents.
      allow delete: if hasRole('admin');
    }

    // Invite Codes Collection: Used for new user sign-ups.
    match /invite_codes/{codeId} {
      // Only Admins and Captains can create new invite codes.
      // They can also specify an initialRole for the user.
      allow create: if hasAnyRole(['admin', 'captain']) &&
        request.resource.data.keys().hasAll(['id', 'generatedBy', 'generatedAt', 'isUsed', 'section', 'initialRole']);

      // Anyone can read an invite code if they know its ID (for signup validation).
      // However, only Admins/Captains can read all codes (e.g., for management UI).
      allow get: if isAuthenticated(); // For single code lookup during signup
      allow list: if hasAnyRole(['admin', 'captain']); // For listing all codes in settings page

      // An unauthenticated user can update an invite code to mark it as used during signup.
      // Admins/Captains can update (e.g., revoke).
      allow update: if (
        // Unauthenticated user can mark as used if it's not already used/revoked
        (!isAuthenticated() && request.resource.data.isUsed == true && resource.data.isUsed == false && resource.data.revoked == false) ||
        // Admins/Captains can update any field (e.g., revoke)
        hasAnyRole(['admin', 'captain'])
      );

      // Only Admins can delete invite codes.
      allow delete: if hasRole('admin');
    }

    // --- Section-Specific Collections (Company) ---

    // Company Boys Collection: Member data for Company section.
    match /company_boys/{boyId} {
      // All authenticated users can read boy data.
      allow read: if isAuthenticated();

      // Admins, Captains, and Officers can create, update, and delete boy data.
      allow create, update, delete: if hasAnyRole(['admin', 'captain', 'officer']);

      // Additional validation for updates:
      // Ensure 'id' field is not changed.
      allow update: if hasAnyRole(['admin', 'captain', 'officer']) &&
        request.resource.data.id == resource.data.id;
    }

    // Company Audit Logs Collection: Tracks all significant actions for Company section.
    match /company_audit_logs/{logId} {
      // All authenticated users can read audit logs.
      allow read: if isAuthenticated();

      // Admins, Captains, and Officers can create audit logs.
      allow create: if hasAnyRole(['admin', 'captain', 'officer']);

      // Only Admins can delete audit logs (e.g., for cleanup).
      allow delete: if hasRole('admin');

      // Audit logs are immutable after creation, so no updates are allowed.
      allow update: if false;
    }

    // --- Section-Specific Collections (Junior) ---

    // Junior Boys Collection: Member data for Junior section.
    match /junior_boys/{boyId} {
      // All authenticated users can read boy data.
      allow read: if isAuthenticated();

      // Admins, Captains, and Officers can create, update, and delete boy data.
      allow create, update, delete: if hasAnyRole(['admin', 'captain', 'officer']);

      // Additional validation for updates:
      // Ensure 'id' field is not changed.
      allow update: if hasAnyRole(['admin', 'captain', 'officer']) &&
        request.resource.data.id == resource.data.id;
    }

    // Junior Audit Logs Collection: Tracks all significant actions for Junior section.
    match /junior_audit_logs/{logId} {
      // All authenticated users can read audit logs.
      allow read: if isAuthenticated();

      // Admins, Captains, and Officers can create audit logs.
      allow create: if hasAnyRole(['admin', 'captain', 'officer']);

      // Only Admins can delete audit logs (e.g., for cleanup).
      allow delete: if hasRole('admin');

      // Audit logs are immutable after creation, so no updates are allowed.
      allow update: if false;
    }

    // Settings Collection: Stores section-specific settings (e.g., meeting day).
    match /settings/{sectionId} {
      // All authenticated users can read settings.
      allow read: if isAuthenticated();

      // Only Admins and Captains can create or update settings.
      allow create, update: if hasAnyRole(['admin', 'captain']);

      // No one can delete settings documents.
      allow delete: if false;
    }
  }
}