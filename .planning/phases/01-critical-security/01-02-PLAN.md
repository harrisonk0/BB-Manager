---
phase: 01-critical-security
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20251214144110_remote_schema.sql
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Security functions exist in database migration"
    - "All security functions use SECURITY DEFINER"
    - "All security functions have hardened search_path"
  artifacts:
    - path: "supabase/migrations/20251214144110_remote_schema.sql"
      provides: "Security functions with search_path hardening"
      contains: "get_user_role", "can_access_section", "can_access_audit_logs"
  key_links:
    - from: "public.get_user_role(text)"
      to: "public.user_roles"
      via: "SECURITY DEFINER function"
      pattern: "SET search_path = public"
---

<objective>
Create security functions with hardened search_path

Purpose: PostgreSQL SECURITY DEFINER functions without explicit `search_path` are vulnerable to CVE-2018-1058, allowing privilege escalation via malicious object creation. This plan creates three security functions (`get_user_role`, `can_access_section`, `can_access_audit_logs`) following the pattern documented for `current_app_role()`, all with `SECURITY DEFINER` and `SET search_path = public`.

Output: Three database security functions with hardened search_path in baseline migration
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/01-critical-security/01-RESEARCH.md
@docs/10-database-security-model.md
@supabase/migrations/20251214144110_remote_schema.sql
</context>

<tasks>

<task type="auto">
  <name>Create get_user_role security function</name>
  <files>supabase/migrations/20251214144110_remote_schema.sql</files>
  <action>
    Append to the baseline migration file a function definition:

    ```sql
    -- Get user role by UID with hardened search_path
    -- SECURITY DEFINER allows reading user_roles even when RLS is enabled
    -- SET search_path = public mitigates CVE-2018-1058
    CREATE OR REPLACE FUNCTION public.get_user_role(user_uid text)
    RETURNS text
    LANGUAGE sql
    STABLE
    SECURITY DEFINER
    SET search_path = public
    AS $$
      SELECT role FROM public.user_roles WHERE uid = user_uid LIMIT 1;
    $$;
    ```

    Why: This function provides a secure way to query user roles from the database. The SECURITY DEFINER attribute allows it to read from user_roles even when RLS is enabled on that table. Hardening search_path prevents search_path attacks.

    Note: Append to baseline migration, not modify existing content (baseline is immutable).
  </action>
  <verify>grep -q "get_user_role" /Users/harrisonk/dev/BB-Manager/supabase/migrations/20251214144110_remote_schema.sql</verify>
  <done>Function definition exists in migration with SECURITY DEFINER and SET search_path = public</done>
</task>

<task type="auto">
  <name>Create can_access_section security function</name>
  <files>supabase/migrations/20251214144110_remote_schema.sql</files>
  <action>
    Append to the baseline migration file a function definition:

    ```sql
    -- Check if user can access a section (all authenticated users can access both sections per security model)
    -- Section is contextual, not a security boundary
    -- SET search_path = public mitigates CVE-2018-1058
    CREATE OR REPLACE FUNCTION public.can_access_section(user_uid text, section_name text)
    RETURNS boolean
    LANGUAGE sql
    STABLE
    SECURITY DEFINER
    SET search_path = public
    AS $$
      SELECT EXISTS (
        SELECT 1 FROM public.user_roles
        WHERE uid = user_uid
      ) AS has_role;
    $$;
    ```

    Why: Per docs/10-database-security-model.md, section is "contextual, not a security boundary" - all authenticated users with a role can access both sections. This function provides a consistent access check API while maintaining the security model.

    Note: The function verifies the user has a role assigned; section isolation is soft and enforced at application level, not database level.
  </action>
  <verify>grep -q "can_access_section" /Users/harrisonk/dev/BB-Manager/supabase/migrations/20251214144110_remote_schema.sql</verify>
  <done>Function definition exists in migration with SECURITY DEFINER and SET search_path = public</done>
</task>

<task type="auto">
  <name>Create can_access_audit_logs security function</name>
  <files>supabase/migrations/20251214144110_remote_schema.sql</files>
  <action>
    Append to the baseline migration file a function definition:

    ```sql
    -- Check if user can access audit logs (Captain and Admin only per security model)
    -- SET search_path = public mitigates CVE-2018-1058
    CREATE OR REPLACE FUNCTION public.can_access_audit_logs(user_uid text)
    RETURNS boolean
    LANGUAGE sql
    STABLE
    SECURITY DEFINER
    SET search_path = public
    AS $$
      SELECT EXISTS (
        SELECT 1 FROM public.user_roles
        WHERE uid = user_uid
        AND role IN ('captain', 'admin')
      );
    $$;
    ```

    Why: Per docs/10-database-security-model.md, audit_logs are readable by "Admins + Captain" only. Officers can INSERT audit logs but not read them. This function enforces that access control at the database level.

    Note: This function will be used by RLS policies when they are implemented (future phase).
  </action>
  <verify>grep -q "can_access_audit_logs" /Users/harrisonk/dev/BB-Manager/supabase/migrations/20251214144110_remote_schema.sql</verify>
  <done>Function definition exists in migration with SECURITY DEFINER and SET search_path = public</done>
</task>

</tasks>

<verification>
1. grep -q "get_user_role" supabase/migrations/20251214144110_remote_schema.sql
2. grep -q "can_access_section" supabase/migrations/20251214144110_remote_schema.sql
3. grep -q "can_access_audit_logs" supabase/migrations/20251214144110_remote_schema.sql
4. grep -q "SECURITY DEFINER" supabase/migrations/20251214144110_remote_schema.sql (should match all 3 functions)
5. grep -q "SET search_path = public" supabase/migrations/20251214144110_remote_schema.sql (should match all 3 functions)
</verification>

<success_criteria>
1. Three security functions defined in baseline migration
2. All functions use SECURITY DEFINER
3. All functions have SET search_path = public
4. Functions follow the current_app_role() pattern from docs
</success_criteria>

<output>
After completion, create `.planning/phases/01-critical-security/01-02-SUMMARY.md`
</output>
