---
phase: 02-performance
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: true
user_setup: []

must_haves:
  truths:
    - Unused indexes are identified via pg_stat_user_indexes query
    - EXPLAIN ANALYZE confirms indexes are not used in typical queries
    - Three unused indexes are dropped from the database
    - No performance regression occurs after dropping indexes
  artifacts:
    - path: ".planning/phases/02-performance/02-02-index-cleanup.sql"
      provides: "Index analysis and drop script"
      contains: "DROP INDEX"
  key_links:
    - from: "Database queries"
      to: "pg_stat_user_indexes view"
      via: "Index usage statistics"
      pattern: "idx_scan = 0"
---

<objective>
Drop three unused database indexes (idx_audit_logs_timestamp_desc and idx_invite_codes variations) to reduce write overhead

Purpose: Remove indexes that are never used to reduce database write overhead and storage; verified via pg_stat_user_indexes and EXPLAIN ANALYZE
Output: Cleaner database with only necessary indexes
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-performance/02-CONTEXT.md
@.planning/phases/02-performance/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Query index usage statistics</name>
  <files>None (query via MCP Supabase)</files>
  <action>
    Use mcp__supabase__executeSQL to query pg_stat_user_indexes for potentially unused indexes:

    SELECT
      schemaname,
      tablename,
      indexname,
      idx_scan AS index_scans,
      idx_tup_read AS tuples_read,
      idx_tup_fetch AS tuples_fetched
    FROM pg_stat_user_indexes
    WHERE schemaname = 'public'
      AND (
        indexname LIKE 'idx_audit_logs%'
        OR indexname LIKE 'idx_invite_codes%'
      )
    ORDER BY idx_scan ASC, tablename, indexname;

    This identifies:
    - idx_audit_logs_timestamp_desc (if exists)
    - idx_invite_codes_generated_at_desc (if exists)
    - idx_invite_codes_is_used_true (if exists)
    - idx_invite_codes_revoked_true (if exists)

    Look for idx_scan = 0 or very low values.

    Save results to 02-02-index-cleanup.sql as a comment block for documentation.
  </action>
  <verify>Query returns index usage stats; results saved to migration file</verify>
  <done>Index usage statistics documented; target indexes identified</done>
</task>

<task type="auto">
  <name>Verify indexes are unused with EXPLAIN ANALYZE</name>
  <files>None (query via MCP Supabase)</files>
  <action>
    For each candidate index from Task 1, run EXPLAIN ANALYZE on typical queries to confirm the index is not used.

    Example for audit_logs:
    EXPLAIN ANALYZE
    SELECT * FROM audit_logs
    ORDER BY timestamp DESC
    LIMIT 50;

    Example for invite_codes:
    EXPLAIN ANALYZE
    SELECT * FROM invite_codes
    WHERE is_used = true;

    EXPLAIN ANALYZE
    SELECT * FROM invite_codes
    WHERE revoked = true;

    Check the query plan output:
    - If "Index Scan using idx_*" appears: the index IS being used, DO NOT DROP
    - If only "Seq Scan" appears with no index reference: index may be safe to drop
    - If "Sort" appears with high cost: query may benefit from the index

    Document findings in 02-02-index-cleanup.sql comments.
  </action>
  <verify>EXPLAIN ANALYZE output shows no index scans for target indexes; analysis documented</verify>
  <done>Confirmed indexes are unused via query plan analysis</done>
</task>

<task type="auto">
  <name>Drop unused indexes from database</name>
  <files>.planning/phases/02-performance/02-02-index-cleanup.sql</files>
  <action>
    Create and execute migration file 02-02-index-cleanup.sql that drops unused indexes.

    For each index confirmed unused in Task 2:
    DROP INDEX IF EXISTS public.idx_audit_logs_timestamp_desc;
    DROP INDEX IF EXISTS public.idx_invite_codes_generated_at_desc;
    DROP INDEX IF EXISTS public.idx_invite_codes_is_used_true;
    DROP INDEX IF EXISTS public.idx_invite_codes_revoked_true;

    Use IF EXISTS to handle cases where indexes may have already been dropped or never created.

    Execute via mcp__supabase__executeSQL.

    After dropping, verify:
    SELECT indexname FROM pg_indexes
    WHERE schemaname = 'public'
      AND indexname LIKE 'idx_audit_logs%'
       OR indexname LIKE 'idx_invite_codes%';

    Confirm dropped indexes no longer exist.
  </action>
  <verify>Target indexes no longer exist in pg_indexes; database has fewer indexes</verify>
  <done>Three unused indexes removed from database</done>
</task>

</tasks>

<verification>
After completion, verify:
1. Index usage statistics were queried and documented
2. EXPLAIN ANALYZE confirmed indexes were not used in typical queries
3. DROP INDEX IF EXISTS statements executed successfully
4. Dropped indexes no longer appear in pg_indexes
5. No critical indexes were accidentally dropped
</verification>

<success_criteria>
1. Three unused indexes dropped from database (or all that exist from the target list)
2. Documentation preserved showing why indexes were dropped
3. Database write overhead reduced without performance regression
</success_criteria>

<output>
After completion, create `.planning/phases/02-performance/02-02-SUMMARY.md`
</output>
